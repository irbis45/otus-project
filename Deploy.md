# Настройка GitLab CI/CD переменных

В вашем проекте GitLab (Settings -> CI/CD -> Variables -> Add variable):

- **SSH_PRIVATE_KEY**: Ваш закрытый SSH-ключ для доступа к серверу.  
  Установите `Type` в `File` и `Protect variable` в `true`.

- **DEPLOY_USER**: Имя пользователя на вашем продакшен-сервере (например, `deployer` или `ubuntu`).

- **DEPLOY_HOST**: IP-адрес или доменное имя вашего продакшен-сервера.

- _(Опционально)_ **DB_DATABASE_PROD**, **DB_USERNAME_PROD**, **DB_PASSWORD_PROD**:  
  Переменные для чувствительных данных `.env.production`. Их можно передавать в SSH-команду через аргументы, чтобы не коммитить `.env.production`.

---

# Итог и рабочий процесс

1. **Разработка:**  
   Работаете локально, Sail работает как обычно. Тестируете локально.

2. **Коммит и Push:**  
   Вы пушите код в ветку `main` (или другую, настроенную для деплоя).

3. **GitLab CI Trigger:**  
   GitLab автоматически запускает пайплайн, который состоит из этапов:

    - **test:**  
      Поднимаются контейнеры Sail (`laravel.test`, `pgsql`, `redis`, `memcached`), запускаются тесты (`phpunit`). Если тесты не прошли — пайплайн останавливается.

    - **build_frontend:**  
      Контейнер `laravel.test` снова поднимается, устанавливаются npm зависимости и запускается `npm run build` для сборки фронтенда.

    - **deploy:**  
      Если предыдущие этапы успешны, GitLab Runner подключается по SSH к вашему продакшен-серверу. На сервере выполняются команды из SSH-блока:

        - Получение свежего кода из Git.
        - Установка Composer-зависимостей.
        - Очистка кэша.
        - Повторный запуск тестов на продакшене (критический шаг для финальной проверки).
        - Применение миграций.
        - Сборка фронтенда (`npm install`, `npm run build`).
        - Оптимизация и прогрев кэша Laravel.
        - Перезапуск очередей.
        - Обновление Docker-контейнеров на сервере (`docker-compose up -d --remove-orphans`).

4. **Rollback:**  
   В случае проблем на продакшене, вы можете вручную запустить job `rollback` в GitLab, который откатит последнюю миграцию.

---

Это комплексное решение обеспечивает высокий уровень автоматизации, тестирования и надёжности для вашего Laravel-проекта на Sail в продакшене.

Если сборка фронтенда (`npm install` и `npm run build`) должна выполняться внутри контейнера Sail, то в скриптах замените вызовы на:
  - ./vendor/bin/sail npm install
  - ./vendor/bin/sail npm run build
